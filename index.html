<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced JPG to PDF Converter</title>
    <meta name="description" content="An advanced, client-side tool to convert JPG and PNG images to a single PDF with full control over editing, ordering, and PDF settings.">

    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- JS Libraries (via CDN) -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
    <script src="https://unpkg.com/downloadjs@1.4.7"></script>

    <style>
        /* Custom Styles & Overrides */
        body {
            background-color: #f8fafc; /* slate-50 */
            font-family: 'Inter', sans-serif;
        }
        @import url('https://rsms.me/inter/inter.css');

        /* Drag & Drop Area */
        .drag-over {
            border-color: #3b82f6; /* blue-500 */
            background-color: #eff6ff; /* blue-50 */
        }
        
        /* Cropper.js Modal */
        .cropper-container {
            max-height: 60vh;
        }

        /* Loading Spinner */
        .spinner {
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Hidden Utility */
        .hidden { display: none !important; }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Advanced Image to PDF Converter</h1>
            <p class="mt-2 text-slate-600">Select images, edit them, and convert to a single PDF — all in your browser.</p>
        </header>

        <!-- Step 1: Image Selection -->
        <section id="upload-section" class="mb-8">
            <div id="drop-zone" class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center cursor-pointer transition-colors hover:border-blue-500 hover:bg-blue-50">
                <input type="file" id="file-input" class="hidden" multiple accept="image/jpeg, image/png">
                <div class="flex flex-col items-center text-slate-500">
                    <!-- Icon: Upload -->
                    <svg class="w-12 h-12 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
                    <p class="font-semibold">Drag & drop your images here</p>
                    <p class="text-sm">or <span class="text-blue-600 font-semibold">click to browse</span></p>
                    <p class="text-xs mt-2 text-slate-400">Supports JPG, PNG. Max 5MB per image.</p>
                </div>
            </div>
        </section>

        <!-- Step 2: Preview & Edit Area -->
        <section id="preview-section" class="hidden">
            <h2 class="text-2xl font-bold mb-4">Your Images</h2>
            <div id="preview-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                <!-- Image preview cards will be injected here -->
            </div>
             <p id="no-images-message" class="text-center py-12 text-slate-500 bg-slate-100 rounded-lg hidden">No images selected. Drop some files above to get started!</p>
        </section>

        <!-- Step 3: PDF Settings & Download -->
        <section id="settings-section" class="mt-8 bg-white p-6 rounded-xl shadow-sm border border-slate-200 hidden">
            <h2 class="text-2xl font-bold mb-4">Final PDF Settings</h2>
            <div class="space-y-4">
                <div>
                    <label for="pdf-filename" class="block text-sm font-medium text-slate-700 mb-1">PDF Filename</label>
                    <input type="text" id="pdf-filename" class="w-full p-2 border border-slate-300 rounded-md focus:ring-blue-500 focus:border-blue-500" value="dearpdf_document.pdf">
                </div>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row items-center gap-4">
                <button id="download-btn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-slate-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                    <!-- Icon: Download -->
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                    <span id="download-btn-text">Download PDF</span>
                    <div id="download-spinner" class="spinner w-5 h-5 rounded-full border-2 border-white/50 hidden"></div>
                </button>
                <button id="clear-all-btn" class="w-full sm:w-auto bg-red-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-600 transition-colors">
                    <!-- Icon: Clear -->
                    <svg class="w-5 h-5 inline-block -mt-1 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                    Clear All
                </button>
            </div>
            <div id="status-message" class="mt-4 text-sm text-center"></div>
        </section>

    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white w-full max-w-3xl rounded-xl shadow-2xl flex flex-col max-h-[95vh]">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-4 border-b">
                <h3 class="text-xl font-semibold">Edit Image</h3>
                <button id="modal-close-btn" class="p-2 rounded-full hover:bg-slate-200">×</button>
            </div>
            <!-- Modal Body -->
            <div class="p-4 flex-grow overflow-y-auto">
                <div class="mb-4">
                    <img id="cropper-image" src="" alt="Image to edit">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div>
                        <label for="edit-filename" class="block text-sm font-medium text-slate-700 mb-1">Page Title / Filename</label>
                        <input type="text" id="edit-filename" class="w-full p-2 border border-slate-300 rounded-md">
                    </div>
                    <div class="flex items-end gap-2">
                        <button id="rotate-btn" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-md flex items-center justify-center gap-2">
                            <!-- Icon: Rotate -->
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 15l-6 6m0 0l-6-6m6 6V9a6 6 0 0112 0v3" /></svg>
                            Rotate 90°
                        </button>
                    </div>
                </div>
            </div>
            <!-- Modal Footer -->
            <div class="p-4 bg-slate-50 border-t flex justify-end gap-3">
                <button id="modal-cancel-btn" class="bg-white hover:bg-slate-100 text-slate-800 font-semibold py-2 px-4 rounded-md border">Cancel</button>
                <button id="modal-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Save Changes</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        'use strict';

        // --- GLOBAL LIBS ---
        const { PDFDocument, rgb } = PDFLib;
        const { Compressor } = window;
        
        // --- DOM ELEMENTS ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const previewSection = document.getElementById('preview-section');
        const settingsSection = document.getElementById('settings-section');
        const noImagesMessage = document.getElementById('no-images-message');
        const previewGrid = document.getElementById('preview-grid');
        const pdfFilenameInput = document.getElementById('pdf-filename');
        const downloadBtn = document.getElementById('download-btn');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const statusMessage = document.getElementById('status-message');
        const downloadBtnText = document.getElementById('download-btn-text');
        const downloadSpinner = document.getElementById('download-spinner');

        // Modal Elements
        const editModal = document.getElementById('edit-modal');
        const cropperImage = document.getElementById('cropper-image');
        const editFilenameInput = document.getElementById('edit-filename');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const rotateBtn = document.getElementById('rotate-btn');
        
        // --- APP STATE ---
        let imagesState = []; // Array of image objects { id, file, dataURL, editedDataURL, title }
        let cropper = null;
        let currentEditImageId = null;

        // --- FUNCTIONS ---

        /**
         * Renders the preview grid based on the current imagesState
         */
        function renderPreviews() {
            previewGrid.innerHTML = '';
            if (imagesState.length > 0) {
                previewSection.classList.remove('hidden');
                settingsSection.classList.remove('hidden');
                noImagesMessage.classList.add('hidden');
                downloadBtn.disabled = false;
                
                imagesState.forEach((img, index) => {
                    const card = document.createElement('div');
                    card.className = 'relative group border border-slate-200 rounded-lg overflow-hidden shadow-sm';
                    card.innerHTML = `
                        <img src="${img.editedDataURL || img.dataURL}" class="w-full h-32 object-cover" alt="${img.title}">
                        <div class="p-2">
                            <p class="text-sm font-medium truncate" title="${img.title}">${img.title}</p>
                            <p class="text-xs text-slate-500">Page ${index + 1}</p>
                        </div>
                        <div class="absolute inset-0 bg-black/60 flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button data-id="${img.id}" class="edit-btn bg-white/80 hover:bg-white text-slate-900 p-2 rounded-full">
                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>
                            </button>
                            <button data-id="${img.id}" class="delete-btn bg-white/80 hover:bg-white text-red-600 p-2 rounded-full">
                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                            </button>
                        </div>
                    `;
                    previewGrid.appendChild(card);
                });
            } else {
                previewSection.classList.add('hidden');
                settingsSection.classList.add('hidden');
                noImagesMessage.classList.remove('hidden');
                downloadBtn.disabled = true;
            }
        }

        /**
         * Handles file selection from both input and drag-drop
         * @param {FileList} files - The list of files to process
         */
        function handleFiles(files) {
            const validFiles = Array.from(files).filter(file => {
                if (!['image/jpeg', 'image/png'].includes(file.type)) {
                    alert(`${file.name} is not a supported file type (only JPG/PNG).`);
                    return false;
                }
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    alert(`${file.name} is too large (max 5MB).`);
                    return false;
                }
                return true;
            });

            validFiles.forEach(file => {
                new Compressor(file, {
                    quality: 0.8,
                    success(result) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const newImage = {
                                id: Date.now() + Math.random(),
                                file: result,
                                dataURL: e.target.result,
                                editedDataURL: null,
                                title: result.name,
                            };
                            imagesState.push(newImage);
                            renderPreviews();
                        };
                        reader.readAsDataURL(result);
                    },
                    error(err) {
                        console.error(err.message);
                    },
                });
            });
        }
        
        /**
         * Opens the modal for editing a specific image
         * @param {number} imageId - The ID of the image to edit
         */
        function openEditModal(imageId) {
            const imageToEdit = imagesState.find(img => img.id === imageId);
            if (!imageToEdit) return;

            currentEditImageId = imageId;
            cropperImage.src = imageToEdit.editedDataURL || imageToEdit.dataURL;
            editFilenameInput.value = imageToEdit.title;
            
            editModal.classList.remove('hidden');
            
            if (cropper) {
                cropper.replace(cropperImage.src);
            } else {
                cropper = new Cropper(cropperImage, {
                    viewMode: 1,
                    background: false,
                    autoCropArea: 0.9,
                });
            }
        }

        function closeEditModal() {
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            editModal.classList.add('hidden');
            currentEditImageId = null;
        }
        
        /**
         * Generates and triggers download of the final PDF
         */
        async function generatePdf() {
            if (imagesState.length === 0) {
                alert("Please select at least one image.");
                return;
            }
            
            setLoadingState(true);
            try {
                const pdfDoc = await PDFDocument.create();
                
                for (let i = 0; i < imagesState.length; i++) {
                    const img = imagesState[i];
                    updateStatus(`Processing image ${i + 1} of ${imagesState.length}...`);
                    
                    const dataUrl = img.editedDataURL || img.dataURL;
                    const imageBytes = await fetch(dataUrl).then(res => res.arrayBuffer());

                    let pdfImage;
                    if (img.file.type === 'image/png') {
                        pdfImage = await pdfDoc.embedPng(imageBytes);
                    } else {
                        pdfImage = await pdfDoc.embedJpg(imageBytes);
                    }

                    const page = pdfDoc.addPage([pdfImage.width, pdfImage.height]);
                    page.drawImage(pdfImage, {
                        x: 0,
                        y: 0,
                        width: pdfImage.width,
                        height: pdfImage.height,
                    });
                }
                
                const pdfBytes = await pdfDoc.save();
                let filename = pdfFilenameInput.value.trim();
                if (!filename.toLowerCase().endsWith('.pdf')) {
                    filename += '.pdf';
                }
                
                download(pdfBytes, filename, "application/pdf");
                updateStatus('PDF generated successfully!', 'success');

            } catch (error) {
                console.error("Error generating PDF:", error);
                updateStatus('An error occurred while generating the PDF. Please try again.', 'error');
            } finally {
                setLoadingState(false);
            }
        }
        
        function setLoadingState(isLoading) {
            downloadBtn.disabled = isLoading;
            if (isLoading) {
                downloadBtnText.classList.add('hidden');
                downloadSpinner.classList.remove('hidden');
            } else {
                downloadBtnText.classList.remove('hidden');
                downloadSpinner.classList.add('hidden');
            }
        }
        
        function updateStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = 'mt-4 text-sm text-center'; // reset
            if (type === 'success') statusMessage.classList.add('text-green-600');
            else if (type === 'error') statusMessage.classList.add('text-red-600');
            else statusMessage.classList.add('text-slate-600');
        }

        // --- EVENT LISTENERS ---

        // File Drop Zone
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        // Preview Grid actions (delegated)
        previewGrid.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-btn');
            const deleteBtn = e.target.closest('.delete-btn');

            if (editBtn) {
                const id = parseFloat(editBtn.dataset.id);
                openEditModal(id);
            }
            if (deleteBtn) {
                const id = parseFloat(deleteBtn.dataset.id);
                imagesState = imagesState.filter(img => img.id !== id);
                renderPreviews();
            }
        });
        
        // Modal actions
        modalCloseBtn.addEventListener('click', closeEditModal);
        modalCancelBtn.addEventListener('click', closeEditModal);
        rotateBtn.addEventListener('click', () => {
            if (cropper) cropper.rotate(90);
        });
        modalSaveBtn.addEventListener('click', () => {
            if (cropper) {
                const imageToEdit = imagesState.find(img => img.id === currentEditImageId);
                if (imageToEdit) {
                    imageToEdit.editedDataURL = cropper.getCroppedCanvas({
                        maxWidth: 4096, // Limit canvas size for performance
                        maxHeight: 4096,
                    }).toDataURL(imageToEdit.file.type);
                    imageToEdit.title = editFilenameInput.value.trim();
                }
                renderPreviews();
            }
            closeEditModal();
        });

        // Main Actions
        downloadBtn.addEventListener('click', generatePdf);
        clearAllBtn.addEventListener('click', () => {
            imagesState = [];
            renderPreviews();
            updateStatus('');
        });

        // --- INITIALIZATION ---
        renderPreviews();
    });
    </script>
</body>
</html>