<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DearPDF - Free Client-Side PDF Tools</title>
    <meta name="description" content="A free, browser-based PDF tool suite. Merge, split, compress, convert, and edit your PDFs securely on your own device. No uploads, no servers.">

    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- JS Libraries via CDN -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/downloadjs@1.4.7"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- Configure PDF.js worker -->
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js`;
    </script>
    
    <style>
        /* Define a cleaner, more professional color palette */
        :root {
            --bg-light: #f8fafc; /* slate-50 */
            --bg-dark: #0f172a;  /* slate-900 */
            --text-light: #020617; /* slate-950 */
            --text-dark: #f1f5f9;  /* slate-100 */
            --surface-light: #ffffff;
            --surface-dark: #1e293b; /* slate-800 */
            --border-light: #e2e8f0; /* slate-200 */
            --border-dark: #334155;  /* slate-700 */
            --primary-color: #3b82f6; /* blue-500 */
            --primary-hover: #2563eb; /* blue-600 */
        }
        html.dark {
            color-scheme: dark;
        }
        body {
            background-color: var(--bg-light);
            color: var(--text-light);
            transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out;
        }
        .dark body {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }
        
        /* Card styles */
        .tool-card {
            background-color: var(--surface-light);
            border: 1px solid var(--border-light);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .dark .tool-card {
            background-color: var(--surface-dark);
            border: 1px solid var(--border-dark);
        }
        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .dark .tool-card:hover {
            box-shadow: 0 10px 15px -3px rgb(59 130 246 / 0.2), 0 4px 6px -4px rgb(59 130 246 / 0.2);
        }

        /* Entrance Animation */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .fade-in-up {
            opacity: 0; /* Start hidden */
            animation: fadeInUp 0.5s ease-out forwards;
        }

        /* File Drop Area */
        .drag-over { border-color: var(--primary-color); }
    </style>
</head>
<body class="antialiased">

    <!-- Header -->
    <header class="py-6 md:py-10">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="text-left">
                <h1 class="text-3xl md:text-4xl font-bold text-[var(--primary-color)]">DearPDF</h1>
                <p class="text-sm md:text-base text-gray-500 dark:text-gray-400 mt-1">Your Complete Suite of Free & Secure PDF Tools</p>
            </div>
            <button id="darkModeToggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                <!-- Sun Icon -->
                <svg id="sunIcon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <!-- Moon Icon -->
                <svg id="moonIcon" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </div>
    </header>

    <!-- Tools Grid -->
    <main class="container mx-auto px-4 py-8">
        <div id="tools-grid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6">
            <!-- Tool cards will be injected here by JS -->
        </div>
    </main>

    <!-- Privacy Section -->
    <section class="container mx-auto px-4 py-12 text-center">
        <h2 class="text-2xl font-bold mb-2">Privacy First. Always.</h2>
        <p class="max-w-2xl mx-auto text-gray-600 dark:text-gray-400">
            DearPDF works entirely in your browser. Your files are never uploaded to any server. All processing happens on your own computer, ensuring your data remains private and secure.
        </p>
    </section>

    <!-- Footer -->
    <footer class="text-center p-6 mt-8 text-sm text-gray-500 dark:text-gray-400 border-t border-[var(--border-light)] dark:border-[var(--border-dark)]">
        © 2024 DearPDF. All rights reserved.
    </footer>

    <!-- Modal -->
    <div id="toolModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div id="modal-panel" class="w-full max-w-2xl bg-[var(--surface-light)] dark:bg-[var(--surface-dark)] rounded-xl shadow-2xl flex flex-col max-h-[90vh] transform transition-all opacity-0 -translate-y-10">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-4 border-b border-[var(--border-light)] dark:border-[var(--border-dark)]">
                <h3 id="modal-title" class="text-xl font-semibold">Tool Title</h3>
                <button id="modal-close-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">×</button>
            </div>
            <!-- Modal Body -->
            <div id="modal-body" class="p-6 overflow-y-auto">
                <!-- Tool-specific content will be injected here -->
            </div>
            <!-- Modal Status -->
            <div id="modal-status" class="px-6 pb-4 mt-auto"></div>
        </div>
    </div>
    
    <!-- Tool Content Templates -->
    <div id="tool-templates" class="hidden">
        <!-- Generic File Drop Area Template -->
        <template id="fileDropTemplate">
            <div class="file-drop-area border-2 border-dashed border-[var(--border-light)] dark:border-[var(--border-dark)] rounded-lg p-8 text-center cursor-pointer bg-gray-50 dark:bg-gray-900/50 hover:border-[var(--primary-color)] transition-colors">
                <input type="file" class="hidden file-input" multiple>
                <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300">Drag & drop files here</h3>
                <p class="text-gray-500 dark:text-gray-400">or click to select files</p>
                <div class="file-list mt-4 text-left text-sm"></div>
            </div>
        </template>
        
        <!-- Individual Tool Templates -->
        <div id="content-merge">
            <p class="mb-6 text-gray-600 dark:text-gray-400">Combine multiple PDFs into a single document. Select at least two files. Files will be merged in the order they are listed.</p>
            <!-- Drop area here -->
            <div class="mt-4 flex justify-end">
                <button data-action="merge" class="action-btn bg-[var(--primary-color)] text-white font-bold py-2 px-6 rounded-lg hover:bg-[var(--primary-hover)] transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Merge PDFs</button>
            </div>
        </div>
        
        <div id="content-split">
            <p class="mb-6 text-gray-600 dark:text-gray-400">Extract a range of pages from a PDF file. Select one PDF to begin.</p>
            <!-- Drop area here -->
            <div class="mt-4 space-y-4">
                <label for="split-pages" class="block font-medium">Pages to extract (e.g., 1-3, 5, 8-10):</label>
                <input type="text" id="split-pages" class="w-full p-2 border border-[var(--border-light)] dark:border-[var(--border-dark)] rounded bg-transparent" placeholder="e.g., 1-3, 5, 8-10">
            </div>
            <div class="mt-4 flex justify-end">
                <button data-action="split" class="action-btn bg-[var(--primary-color)] text-white font-bold py-2 px-6 rounded-lg hover:bg-[var(--primary-hover)] transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Split PDF</button>
            </div>
        </div>

        <div id="content-compress">
            <p class="mb-6 text-gray-600 dark:text-gray-400">Reduce the file size of your PDF. Lower quality results in a smaller file. This process re-encodes each page as a JPG.</p>
            <!-- Drop area here -->
            <div class="mt-4 space-y-4">
                <label for="compress-quality" class="block font-medium">Compression Quality:</label>
                <select id="compress-quality" class="w-full p-2 border border-[var(--border-light)] dark:border-[var(--border-dark)] rounded bg-transparent">
                    <option value="0.5">Low (Smallest Size)</option>
                    <option value="0.75" selected>Medium</option>
                    <option value="0.9">High (Best Quality)</option>
                </select>
            </div>
            <div class="mt-4 flex justify-end">
                <button data-action="compress" class="action-btn bg-[var(--primary-color)] text-white font-bold py-2 px-6 rounded-lg hover:bg-[var(--primary-hover)] transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Compress PDF</button>
            </div>
        </div>
        
        <div id="content-pdf-to-text">
            <p class="mb-6 text-gray-600 dark:text-gray-400">Extract all text content from a PDF file and download it as a .txt file.</p>
            <!-- Drop area here -->
            <div class="mt-4 flex justify-end">
                <button data-action="pdfToText" class="action-btn bg-[var(--primary-color)] text-white font-bold py-2 px-6 rounded-lg hover:bg-[var(--primary-hover)] transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Convert to Text</button>
            </div>
        </div>
        
        <div id="content-pdf-to-ppt">
             <p class="mb-6 text-gray-600 dark:text-gray-400">This tool converts each page of your PDF into a JPG image, bundled in a ZIP file. You can then insert these images into your PowerPoint slides.</p>
             <!-- Drop area here -->
             <div class="mt-4 flex justify-end">
                <button data-action="pdfToPpt" class="action-btn bg-[var(--primary-color)] text-white font-bold py-2 px-6 rounded-lg hover:bg-[var(--primary-hover)] transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Convert to Images</button>
            </div>
        </div>
        
        <div id="content-word-to-pdf">
            <div class="p-4 bg-yellow-100 dark:bg-yellow-900/50 border-l-4 border-yellow-500 text-yellow-800 dark:text-yellow-200 rounded">
                <h3 class="font-bold">Feature Not Available in Browser</h3>
                <p>Converting DOCX to PDF requires complex server-side processing. To convert a Word document to PDF, please use your word processor (e.g., Microsoft Word, Google Docs) and select "Save as PDF" or "Export as PDF".</p>
            </div>
        </div>
        
        <div id="content-excel-to-pdf">
             <div class="p-4 bg-yellow-100 dark:bg-yellow-900/50 border-l-4 border-yellow-500 text-yellow-800 dark:text-yellow-200 rounded">
                <h3 class="font-bold">Feature Not Available in Browser</h3>
                <p>Converting XLSX to PDF is not possible in a browser. Please use your spreadsheet software (e.g., Microsoft Excel, Google Sheets) and use the "Save as PDF" or "Export as PDF" function.</p>
            </div>
        </div>
        
        <div id="content-pdf-to-jpg">
            <p class="mb-6 text-gray-600 dark:text-gray-400">Convert each page of a PDF into a JPG image. Multi-page PDFs will be downloaded as a ZIP file.</p>
            <!-- Drop area here -->
             <div class="mt-4 flex justify-end">
                <button data-action="pdfToJpg" class="action-btn bg-[var(--primary-color)] text-white font-bold py-2 px-6 rounded-lg hover:bg-[var(--primary-hover)] transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Convert to JPG</button>
            </div>
        </div>

        <div id="content-image-to-pdf">
            <p class="mb-6 text-gray-600 dark:text-gray-400">Convert JPG, PNG, or other image files into a single PDF document. Each image will be placed on a separate page.</p>
            <!-- Drop area here -->
            <div class="mt-4 flex justify-end">
                <button data-action="imageToPdf" class="action-btn bg-[var(--primary-color)] text-white font-bold py-2 px-6 rounded-lg hover:bg-[var(--primary-hover)] transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Convert to PDF</button>
            </div>
        </div>

        <div id="content-protect">
            <p class="mb-6 text-gray-600 dark:text-gray-400">Add a password to your PDF file to prevent unauthorized access.</p>
            <!-- Drop area here -->
            <div class="mt-4 space-y-4">
                <label for="protect-password" class="block font-medium">Set Password:</label>
                <input type="password" id="protect-password" class="w-full p-2 border border-[var(--border-light)] dark:border-[var(--border-dark)] rounded bg-transparent" placeholder="Enter a strong password">
            </div>
            <div class="mt-4 flex justify-end">
                <button data-action="protect" class="action-btn bg-[var(--primary-color)] text-white font-bold py-2 px-6 rounded-lg hover:bg-[var(--primary-hover)] transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Protect PDF</button>
            </div>
        </div>
        
        <div id="content-unlock">
            <p class="mb-6 text-gray-600 dark:text-gray-400">Remove a password from a PDF file. You must know the current password to unlock it.</p>
            <!-- Drop area here -->
            <div class="mt-4 space-y-4">
                <label for="unlock-password" class="block font-medium">Current Password:</label>
                <input type="password" id="unlock-password" class="w-full p-2 border border-[var(--border-light)] dark:border-[var(--border-dark)] rounded bg-transparent" placeholder="Enter the current PDF password">
            </div>
            <div class="mt-4 flex justify-end">
                <button data-action="unlock" class="action-btn bg-[var(--primary-color)] text-white font-bold py-2 px-6 rounded-lg hover:bg-[var(--primary-hover)] transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Unlock PDF</button>
            </div>
        </div>

        <div id="content-watermark">
            <p class="mb-6 text-gray-600 dark:text-gray-400">Stamp text over your PDF pages as a watermark.</p>
            <!-- Drop area here -->
            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                   <label for="watermark-text" class="block font-medium mb-1">Watermark Text:</label>
                   <input type="text" id="watermark-text" class="w-full p-2 border border-[var(--border-light)] dark:border-[var(--border-dark)] rounded bg-transparent" value="CONFIDENTIAL">
                </div>
                <div>
                   <label for="watermark-size" class="block font-medium mb-1">Font Size:</label>
                   <input type="number" id="watermark-size" class="w-full p-2 border border-[var(--border-light)] dark:border-[var(--border-dark)] rounded bg-transparent" value="50">
                </div>
                <div>
                   <label for="watermark-opacity" class="block font-medium mb-1">Opacity (0.0 - 1.0):</label>
                   <input type="number" id="watermark-opacity" step="0.1" min="0" max="1" class="w-full p-2 border border-[var(--border-light)] dark:border-[var(--border-dark)] rounded bg-transparent" value="0.5">
                </div>
                <div>
                   <label for="watermark-color" class="block font-medium mb-1">Color:</label>
                   <input type="color" id="watermark-color" class="w-full p-1 h-10 border border-[var(--border-light)] dark:border-[var(--border-dark)] rounded bg-transparent" value="#ff0000">
                </div>
            </div>
            <div class="mt-4 flex justify-end">
                <button data-action="watermark" class="action-btn bg-[var(--primary-color)] text-white font-bold py-2 px-6 rounded-lg hover:bg-[var(--primary-hover)] transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Add Watermark</button>
            </div>
        </div>

        <div id="content-rotate">
            <p class="mb-6 text-gray-600 dark:text-gray-400">Rotate all pages of a PDF file clockwise.</p>
            <!-- Drop area here -->
            <div class="mt-4 space-y-4">
                <label for="rotate-angle" class="block font-medium">Rotation Angle:</label>
                <select id="rotate-angle" class="w-full p-2 border border-[var(--border-light)] dark:border-[var(--border-dark)] rounded bg-transparent">
                    <option value="90">90° Clockwise</option>
                    <option value="180">180°</option>
                    <option value="270">270° Clockwise (or 90° anti-clockwise)</option>
                </select>
            </div>
            <div class="mt-4 flex justify-end">
                <button data-action="rotate" class="action-btn bg-[var(--primary-color)] text-white font-bold py-2 px-6 rounded-lg hover:bg-[var(--primary-hover)] transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Rotate PDF</button>
            </div>
        </div>

        <div id="content-page-numbers">
            <p class="mb-6 text-gray-600 dark:text-gray-400">Insert page numbers into your PDF document in a 'Page X of Y' format.</p>
            <!-- Drop area here -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div>
                    <label for="pagenum-position" class="block font-medium mb-1">Position:</label>
                    <select id="pagenum-position" class="w-full p-2 border border-[var(--border-light)] dark:border-[var(--border-dark)] rounded bg-transparent">
                        <option value="bottom-right" selected>Bottom Right</option>
                        <option value="bottom-center">Bottom Center</option>
                        <option value="bottom-left">Bottom Left</option>
                        <option value="top-right">Top Right</option>
                        <option value="top-center">Top Center</option>
                        <option value="top-left">Top Left</option>
                    </select>
                </div>
                <div>
                   <label for="pagenum-size" class="block font-medium mb-1">Font Size:</label>
                   <input type="number" id="pagenum-size" class="w-full p-2 border border-[var(--border-light)] dark:border-[var(--border-dark)] rounded bg-transparent" value="12">
                </div>
            </div>
            <div class="mt-4 flex justify-end">
                <button data-action="pageNumbers" class="action-btn bg-[var(--primary-color)] text-white font-bold py-2 px-6 rounded-lg hover:bg-[var(--primary-hover)] transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Add Page Numbers</button>
            </div>
        </div>
        
        <div id="content-ocr">
            <div class="p-4 bg-yellow-100 dark:bg-yellow-900/50 border-l-4 border-yellow-500 text-yellow-800 dark:text-yellow-200 rounded">
                <h3 class="font-bold">Feature Not Available (Dummy)</h3>
                <p>Performing Optical Character Recognition (OCR) is a very resource-intensive task that is not well-suited for a browser environment. For best results, we recommend using dedicated desktop or server-based OCR software.</p>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        'use strict';
        
        // --- Library Globals ---
        const { PDFDocument, rgb, degrees, StandardFonts } = PDFLib;
        const { pdfjsLib } = window;
        const { JSZip } = window;
        
        // --- App Data ---
        const tools = [
            { id: 'merge', title: 'Merge PDF', desc: 'Combine multiple PDFs into one.', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mb-3 text-blue-500"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 16.875h3.375m0 0h3.375m-3.375 0V13.5m0 3.375v3.375M6 10.5h2.25a2.25 2.25 0 002.25-2.25V6a2.25 2.25 0 00-2.25-2.25H6.75A2.25 2.25 0 004.5 6v2.25a2.25 2.25 0 002.25 2.25zm13.5 0h-2.25a2.25 2.25 0 00-2.25 2.25v2.25a2.25 2.25 0 002.25 2.25H19.5a2.25 2.25 0 002.25-2.25v-2.25a2.25 2.25 0 00-2.25-2.25z" /></svg>' },
            { id: 'split', title: 'Split PDF', desc: 'Extract pages from a PDF.', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mb-3 text-red-500"><path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.4 2.245 4.5 4.5 0 008.4-2.245c0-.399-.078-.78-.22-1.128zm0 0a15.998 15.998 0 003.388-1.62m-5.043-.025a15.998 15.998 0 011.622-3.385m5.043.025a15.998 15.998 0 001.622-3.385m3.388 1.62a15.998 15.998 0 00-1.62-3.385m-5.043-.025a15.998 15.998 0 01-3.388-1.621m7.744 7.744a15.998 15.998 0 00-3.388 1.622m5.043.025a15.998 15.998 0 01-1.622 3.385m-5.043-.025a15.998 15.998 0 00-1.622 3.385m-3.388-1.62a15.998 15.998 0 001.62 3.385" /></svg>' },
            { id: 'compress', title: 'Compress PDF', desc: 'Reduce the file size of a PDF.', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mb-3 text-yellow-500"><path stroke-linecap="round" stroke-linejoin="round" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5M15 15l5.25 5.25" /></svg>' },
            { id: 'pdf-to-text', title: 'PDF to Text', desc: 'Extract text from a PDF file.', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mb-3 text-green-500"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75c0-.231-.035-.454-.1-.664M6.75 7.5h.75v.75h-.75V7.5zM6.75 10.5h.75v.75h-.75v-.75zM6.75 13.5h.75v.75h-.75v-.75zM6.75 16.5h.75v.75h-.75v-.75zM4.5 6.108c0-1.135.845-2.098 1.976-2.192a48.424 48.424 0 011.123-.08m-5.801 0c.065.21.1.433.1.664 0 .414-.336.75-.75.75h-4.5a.75.75 0 01-.75-.75c0-.231.035-.454.1-.664M4.5 12V2.25" /></svg>'},
            { id: 'pdf-to-ppt', title: 'PDF to PowerPoint', desc: 'Convert PDF pages to images.', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mb-3 text-orange-500"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 7.5h-.75A2.25 2.25 0 004.5 9.75v7.5a2.25 2.25 0 002.25 2.25h7.5a2.25 2.25 0 002.25-2.25v-7.5a2.25 2.25 0 00-2.25-2.25h-.75m-6 3.75l3 3m0 0l3-3m-3 3V1.5m6 9h.75a2.25 2.25 0 012.25 2.25v7.5a2.25 2.25 0 01-2.25 2.25h-7.5a2.25 2.25 0 01-2.25-2.25v-.75" /></svg>'},
            { id: 'word-to-pdf', title: 'Word to PDF', desc: 'Not available in browser.', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mb-3 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13.5l3 3m0 0l3-3m-3 3v-6m1.06-4.19l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" /></svg>'},
            { id: 'excel-to-pdf', title: 'Excel to PDF', desc: 'Not available in browser.', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mb-3 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>' },
            { id: 'pdf-to-jpg', title: 'PDF to JPG', desc: 'Convert PDF pages to JPGs.', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mb-3 text-purple-500"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>' },
            { id: 'image-to-pdf', title: 'Image to PDF', desc: 'Convert images to a PDF file.', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mb-3 text-pink-500"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>' },
            { id: 'protect', title: 'Protect PDF', desc: 'Add a password to a PDF.', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mb-3 text-indigo-500"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" /></svg>' },
            { id: 'unlock', title: 'Unlock PDF', desc: 'Remove password from a PDF.', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mb-3 text-cyan-500"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m11.25 3.75v-1.5a2.25 2.25 0 00-2.25-2.25H10.5a2.25 2.25 0 00-2.25 2.25v1.5m11.25 0h-10.5a2.25 2.25 0 00-2.25 2.25v3.75a2.25 2.25 0 002.25 2.25h10.5a2.25 2.25 0 002.25-2.25v-3.75a2.25 2.25 0 00-2.25-2.25z" /></svg>' },
            { id: 'watermark', title: 'Add Watermark', desc: 'Stamp text onto PDF pages.', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mb-3 text-teal-500"><path stroke-linecap="round" stroke-linejoin="round" d="M7.864 4.243A7.5 7.5 0 0119.5 10.5c0 2.92-.556 5.709-1.588 8.12-2.348 4.467-9.43 4.467-11.776 0A7.5 7.5 0 017.864 4.243z" /></svg>' },
            { id: 'rotate', title: 'Rotate PDF', desc: 'Rotate all pages in a PDF.', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mb-3 text-rose-500"><path stroke-linecap="round" stroke-linejoin="round" d="M15 15l-6 6m0 0l-6-6m6 6V9a6 6 0 0112 0v3" /></svg>' },
            { id: 'page-numbers', title: 'Add Page Numbers', desc: 'Insert page numbers in a PDF.', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mb-3 text-lime-500"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 1.5m1-1.5l1-1.5m0 0l1 1.5m-2-1.5v5.25m0 0l1 1.5m-1-1.5l-1 1.5m0 0l-1 1.5m2-3l1 1.5M12 9.75l1 1.5m-1-1.5l-1 1.5m-1.5-3l1 1.5m1-1.5l-1 1.5" /></svg>' },
            { id: 'ocr', title: 'OCR PDF', desc: 'Not available in browser.', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mb-3 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6" /></svg>' },
        ];
        
        // --- UI Elements ---
        const darkModeToggle = document.getElementById('darkModeToggle');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');
        const toolsGrid = document.getElementById('tools-grid');
        const toolModal = document.getElementById('toolModal');
        const modalPanel = document.getElementById('modal-panel');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalStatus = document.getElementById('modal-status');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // --- App State ---
        let selectedFiles = null;
        
        // --- Helper Functions ---
        const showStatus = (message, type = 'info') => {
            modalStatus.innerHTML = '';
            const statusDiv = document.createElement('div');
            statusDiv.textContent = message;
            statusDiv.className = 'p-3 rounded-md text-sm';
            if (type === 'error') {
                statusDiv.classList.add('bg-red-100', 'dark:bg-red-900/50', 'text-red-800', 'dark:text-red-200');
            } else if (type === 'success') {
                statusDiv.classList.add('bg-green-100', 'dark:bg-green-900/50', 'text-green-800', 'dark:text-green-200');
            } else {
                statusDiv.classList.add('bg-blue-100', 'dark:bg-blue-900/50', 'text-blue-800', 'dark:text-blue-200');
            }
            modalStatus.appendChild(statusDiv);
        };
        const hideStatus = () => { modalStatus.innerHTML = ''; };
        const readFileAsArrayBuffer = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
        });

        // --- Dark Mode ---
        const applyDarkMode = (isDark) => {
            if (isDark) {
                document.documentElement.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
        };
        darkModeToggle.addEventListener('click', () => {
            const isDark = !document.documentElement.classList.contains('dark');
            localStorage.setItem('darkMode', isDark);
            applyDarkMode(isDark);
        });
        
        // --- Modal Logic ---
        const openModal = (tool) => {
            // 1. Populate modal
            modalTitle.textContent = tool.title;
            modalBody.innerHTML = ''; // Clear previous content
            const contentTemplate = document.getElementById(`content-${tool.id}`);
            if (contentTemplate) {
                const content = contentTemplate.cloneNode(true);
                modalBody.appendChild(content);
            }
            hideStatus();
            
            // 2. Setup file drop if needed
            if (!['word-to-pdf', 'excel-to-pdf', 'ocr'].includes(tool.id)) {
                setupFileDropArea(modalBody);
            }
            
            // 3. Attach action listener
            const actionBtn = modalBody.querySelector('.action-btn');
            if(actionBtn) {
                actionBtn.addEventListener('click', () => {
                    const action = actionBtn.dataset.action;
                    if(pdfActions[action]) {
                        pdfActions[action]();
                    }
                });
            }

            // 4. Show modal with animation
            toolModal.classList.remove('hidden');
            setTimeout(() => { // Allow display block to register before starting transition
                modalPanel.classList.remove('opacity-0', '-translate-y-10');
                modalPanel.classList.add('opacity-100', 'translate-y-0');
            }, 10);
        };
        
        const closeModal = () => {
            modalPanel.classList.add('opacity-0', '-translate-y-10');
            modalPanel.classList.remove('opacity-100', 'translate-y-0');
            setTimeout(() => {
                toolModal.classList.add('hidden');
                selectedFiles = null; // Reset files on close
            }, 300); // Match transition duration
        };

        modalCloseBtn.addEventListener('click', closeModal);
        toolModal.addEventListener('click', (e) => {
            if (e.target === toolModal) closeModal();
        });
        
        // --- File Handling ---
        const updateProcessButtonState = () => {
            const btn = modalBody.querySelector('.action-btn');
            if (btn) btn.disabled = !selectedFiles || selectedFiles.length === 0;
        };

        const handleFileSelect = (files) => {
            selectedFiles = files;
            const fileListDiv = modalBody.querySelector('.file-list');
            fileListDiv.innerHTML = '';
            if (files.length > 0) {
                const list = document.createElement('ul');
                list.className = 'list-disc pl-5 space-y-1 text-gray-600 dark:text-gray-400';
                Array.from(files).forEach(file => {
                    const li = document.createElement('li');
                    li.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                    list.appendChild(li);
                });
                fileListDiv.appendChild(list);
            }
            updateProcessButtonState();
            hideStatus();
        };

        const setupFileDropArea = (container) => {
            const template = document.getElementById('fileDropTemplate');
            const clone = template.content.cloneNode(true);
            const dropArea = clone.querySelector('.file-drop-area');
            const fileInput = clone.querySelector('.file-input');
            
            container.prepend(clone); // Add drop area to the top of the modal body

            dropArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', () => handleFileSelect(fileInput.files));
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
            });
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => dropArea.classList.add('drag-over'), false);
            });
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => dropArea.classList.remove('drag-over'), false);
            });
            dropArea.addEventListener('drop', e => handleFileSelect(e.dataTransfer.files), false);
        };
        
        // --- PDF Actions Object ---
        // Bundling all processing functions into a single object for clarity
        const pdfActions = {
            merge: async () => {
                if (!selectedFiles || selectedFiles.length < 2) { showStatus('Please select at least two PDF files.', 'error'); return; }
                showStatus('Merging PDFs...');
                try {
                    const mergedPdf = await PDFDocument.create();
                    for (const file of selectedFiles) {
                        const pdfBytes = await readFileAsArrayBuffer(file);
                        const pdf = await PDFDocument.load(pdfBytes);
                        const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                        copiedPages.forEach(page => mergedPdf.addPage(page));
                    }
                    const mergedPdfBytes = await mergedPdf.save();
                    download(mergedPdfBytes, "dearpdf_merged.pdf", "application/pdf");
                    showStatus('Merge successful!', 'success');
                } catch (e) { showStatus(`Error: ${e.message}`, 'error'); }
            },
            split: async () => { /* ... implementation ... */ },
            compress: async () => { /* ... implementation ... */ },
            // Add all other functions here...
            split: async () => {
                const pageRanges = document.getElementById('split-pages').value;
                if (!selectedFiles || selectedFiles.length !== 1) { showStatus('Please select exactly one PDF file.', 'error'); return; }
                if (!pageRanges) { showStatus('Please enter the pages to extract.', 'error'); return; }
                showStatus('Splitting PDF...');
                try {
                    const pdfBytes = await readFileAsArrayBuffer(selectedFiles[0]);
                    const pdf = await PDFDocument.load(pdfBytes);
                    const newPdf = await PDFDocument.create();
                    
                    const pageIndices = pageRanges.split(',').flatMap(range => {
                        if (range.includes('-')) {
                            const [start, end] = range.split('-').map(Number);
                            return Array.from({length: end - start + 1}, (_, i) => start + i - 1);
                        }
                        return Number(range.trim()) - 1;
                    }).filter(index => index >= 0 && index < pdf.getPageCount());

                    const copiedPages = await newPdf.copyPages(pdf, pageIndices);
                    copiedPages.forEach(page => newPdf.addPage(page));

                    const newPdfBytes = await newPdf.save();
                    download(newPdfBytes, "dearpdf_split.pdf", "application/pdf");
                    showStatus('Split successful!', 'success');
                } catch (e) { showStatus(`Error: ${e.message}`, 'error'); }
            },
            compress: async () => {
                if (!selectedFiles || selectedFiles.length !== 1) { showStatus('Please select one PDF file.', 'error'); return; }
                const quality = parseFloat(document.getElementById('compress-quality').value);
                showStatus('Compressing PDF... This can take a moment.');
                try {
                    const pdfBytes = await readFileAsArrayBuffer(selectedFiles[0]);
                    const pdfDoc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                    const newPdf = await PDFDocument.create();

                    for (let i = 1; i <= pdfDoc.numPages; i++) {
                        const page = await pdfDoc.getPage(i);
                        const viewport = page.getViewport({ scale: 1.5 });
                        const canvas = document.createElement('canvas');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        const context = canvas.getContext('2d');
                        
                        await page.render({ canvasContext: context, viewport: viewport }).promise;
                        const jpgDataUrl = canvas.toDataURL('image/jpeg', quality);
                        const jpgImageBytes = await fetch(jpgDataUrl).then(res => res.arrayBuffer());
                        const jpgImage = await newPdf.embedJpg(jpgImageBytes);
                        
                        const newPage = newPdf.addPage([page.view[2], page.view[3]]);
                        newPage.drawImage(jpgImage, { x: 0, y: 0, width: newPage.getWidth(), height: newPage.getHeight() });
                    }
                    const newPdfBytes = await newPdf.save();
                    download(newPdfBytes, "dearpdf_compressed.pdf", "application/pdf");
                    showStatus('Compression successful!', 'success');
                } catch (e) { showStatus(`Error: ${e.message}`, 'error'); }
            },
            pdfToText: async () => {
                if (!selectedFiles || selectedFiles.length !== 1) { showStatus('Please select one PDF file.', 'error'); return; }
                showStatus('Extracting text...');
                try {
                    const pdfBytes = await readFileAsArrayBuffer(selectedFiles[0]);
                    const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                    let textContent = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const text = await page.getTextContent();
                        textContent += text.items.map(item => item.str).join(' ') + '\n\n';
                    }
                    download(new Blob([textContent], { type: 'text/plain' }), 'dearpdf_extracted.txt');
                    showStatus('Text extraction successful!', 'success');
                } catch (e) { showStatus(`Error: ${e.message}`, 'error'); }
            },
            convertPdfToImages: async (format = 'jpeg') => {
                if (!selectedFiles || selectedFiles.length !== 1) { showStatus(`Please select one PDF file.`, 'error'); return null; }
                showStatus(`Converting PDF to ${format.toUpperCase()}...`);
                try {
                    const pdfBytes = await readFileAsArrayBuffer(selectedFiles[0]);
                    const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                    const images = [];
                    for (let i = 1; i <= pdf.numPages; i++) {
                        showStatus(`Processing page ${i} of ${pdf.numPages}...`, 'info');
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: 2.0 });
                        const canvas = document.createElement('canvas');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        const context = canvas.getContext('2d');
                        await page.render({ canvasContext: context, viewport: viewport }).promise;
                        images.push(canvas.toDataURL(`image/${format}`));
                    }
                    return images;
                } catch (e) { showStatus(`Error: ${e.message}`, 'error'); return null; }
            },
            pdfToPpt: async function() { await this.pdfToJpg() }, // Alias for pdfToJpg
            pdfToJpg: async function() {
                const images = await this.convertPdfToImages('jpeg');
                if (images) {
                    if (images.length === 1) {
                        download(images[0], 'dearpdf_page_1.jpg');
                    } else {
                        const zip = new JSZip();
                        images.forEach((imgDataUrl, i) => { zip.file(`page_${i + 1}.jpg`, imgDataUrl.split(',')[1], { base64: true }); });
                        const zipBlob = await zip.generateAsync({ type: 'blob' });
                        download(zipBlob, 'dearpdf_images.zip');
                    }
                    showStatus('Conversion successful!', 'success');
                }
            },
            imageToPdf: async () => {
                if (!selectedFiles || selectedFiles.length === 0) { showStatus('Please select one or more image files.', 'error'); return; }
                showStatus('Converting images to PDF...');
                try {
                    const newPdf = await PDFDocument.create();
                    for (const file of selectedFiles) {
                        const imgBytes = await readFileAsArrayBuffer(file);
                        let image;
                        if (file.type === 'image/jpeg') image = await newPdf.embedJpg(imgBytes);
                        else if (file.type === 'image/png') image = await newPdf.embedPng(imgBytes);
                        else { showStatus(`Unsupported image: ${file.name}. Please use JPG or PNG.`, 'error'); continue; }
                        const page = newPdf.addPage([image.width, image.height]);
                        page.drawImage(image, { x: 0, y: 0, width: image.width, height: image.height });
                    }
                    if(newPdf.getPageCount() > 0) {
                        const newPdfBytes = await newPdf.save();
                        download(newPdfBytes, "dearpdf_from_images.pdf", "application/pdf");
                        showStatus('Image to PDF conversion successful!', 'success');
                    }
                } catch (e) { showStatus(`Error: ${e.message}`, 'error'); }
            },
            protect: async () => {
                const password = document.getElementById('protect-password').value;
                if (!selectedFiles || selectedFiles.length !== 1) { showStatus('Please select one PDF file.', 'error'); return; }
                if (!password) { showStatus('Please enter a password.', 'error'); return; }
                showStatus('Encrypting PDF...');
                try {
                    const pdfBytes = await readFileAsArrayBuffer(selectedFiles[0]);
                    const pdfDoc = await PDFDocument.load(pdfBytes);
                    pdfDoc.setProducer('DearPDF');
                    pdfDoc.setCreator('DearPDF');
                    const protectedPdfBytes = await pdfDoc.save({ useObjectStreams: false, encryption: { userPassword: password, ownerPassword: password, permissions: { printing: 'highResolution', copying: false } } });
                    download(protectedPdfBytes, 'dearpdf_protected.pdf', 'application/pdf');
                    showStatus('PDF protected successfully!', 'success');
                } catch(e) { showStatus(`Error: ${e.message}`, 'error'); }
            },
            unlock: async () => {
                const password = document.getElementById('unlock-password').value;
                if (!selectedFiles || selectedFiles.length !== 1) { showStatus('Please select one PDF file.', 'error'); return; }
                if (!password) { showStatus('Please enter the current password.', 'error'); return; }
                showStatus('Attempting to unlock PDF...');
                try {
                    const pdfBytes = await readFileAsArrayBuffer(selectedFiles[0]);
                    const pdfDoc = await PDFDocument.load(pdfBytes, { ownerPassword: password });
                    const unlockedPdfBytes = await pdfDoc.save();
                    download(unlockedPdfBytes, 'dearpdf_unlocked.pdf', 'application/pdf');
                    showStatus('PDF unlocked successfully!', 'success');
                } catch(e) { showStatus(`Error: Incorrect password or PDF is not encrypted.`, 'error'); }
            },
            watermark: async () => {
                if (!selectedFiles || selectedFiles.length !== 1) { showStatus('Please select one PDF file.', 'error'); return; }
                const text = document.getElementById('watermark-text').value;
                const size = parseInt(document.getElementById('watermark-size').value);
                const opacity = parseFloat(document.getElementById('watermark-opacity').value);
                const colorHex = document.getElementById('watermark-color').value;
                const color = rgb(parseInt(colorHex.slice(1, 3), 16) / 255, parseInt(colorHex.slice(3, 5), 16) / 255, parseInt(colorHex.slice(5, 7), 16) / 255);
                
                showStatus('Adding watermark...');
                try {
                    const pdfBytes = await readFileAsArrayBuffer(selectedFiles[0]);
                    const pdfDoc = await PDFDocument.load(pdfBytes);
                    const helveticaFont = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
                    const pages = pdfDoc.getPages();
                    for (const page of pages) {
                        const { width, height } = page.getSize();
                        const textWidth = helveticaFont.widthOfTextAtSize(text, size);
                        page.drawText(text, { x: width / 2 - textWidth / 2, y: height / 2, font: helveticaFont, size, color, opacity, rotate: degrees(45) });
                    }
                    const newPdfBytes = await pdfDoc.save();
                    download(newPdfBytes, 'dearpdf_watermarked.pdf', 'application/pdf');
                    showStatus('Watermark added successfully!', 'success');
                } catch (e) { showStatus(`Error: ${e.message}`, 'error'); }
            },
            rotate: async () => {
                if (!selectedFiles || selectedFiles.length !== 1) { showStatus('Please select one PDF file.', 'error'); return; }
                const angle = parseInt(document.getElementById('rotate-angle').value);
                showStatus('Rotating PDF...');
                try {
                    const pdfBytes = await readFileAsArrayBuffer(selectedFiles[0]);
                    const pdfDoc = await PDFDocument.load(pdfBytes);
                    pdfDoc.getPages().forEach(page => { page.setRotation(degrees((page.getRotation().angle + angle) % 360)); });
                    const newPdfBytes = await pdfDoc.save();
                    download(newPdfBytes, 'dearpdf_rotated.pdf', 'application/pdf');
                    showStatus('Rotation successful!', 'success');
                } catch (e) { showStatus(`Error: ${e.message}`, 'error'); }
            },
            pageNumbers: async () => {
                if (!selectedFiles || selectedFiles.length !== 1) { showStatus('Please select one PDF file.', 'error'); return; }
                showStatus('Adding page numbers...');
                try {
                    const pdfBytes = await readFileAsArrayBuffer(selectedFiles[0]);
                    const pdfDoc = await PDFDocument.load(pdfBytes);
                    const helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica);
                    const pages = pdfDoc.getPages();
                    const totalPages = pages.length;
                    const position = document.getElementById('pagenum-position').value;
                    const size = parseInt(document.getElementById('pagenum-size').value);
                    const margin = 30;

                    for (let i = 0; i < totalPages; i++) {
                        const page = pages[i];
                        const { width, height } = page.getSize();
                        const text = `Page ${i + 1} of ${totalPages}`;
                        const textWidth = helveticaFont.widthOfTextAtSize(text, size);
                        
                        let x, y;
                        if(position.includes('bottom')) y = margin; else y = height - size - margin;
                        if(position.includes('left')) x = margin; else if(position.includes('right')) x = width - textWidth - margin; else x = width / 2 - textWidth / 2;

                        page.drawText(text, { x, y, font: helveticaFont, size, color: rgb(0.3, 0.3, 0.3) });
                    }
                    const newPdfBytes = await pdfDoc.save();
                    download(newPdfBytes, 'dearpdf_numbered.pdf', 'application/pdf');
                    showStatus('Page numbers added successfully!', 'success');
                } catch (e) { showStatus(`Error: ${e.message}`, 'error'); }
            }
        };


        // --- Initialization ---
        const init = () => {
            // 1. Set dark mode
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const savedTheme = localStorage.getItem('darkMode');
            if (savedTheme === 'true' || (savedTheme === null && prefersDark)) {
                applyDarkMode(true);
            } else {
                applyDarkMode(false);
            }
            
            // 2. Populate tools grid
            tools.forEach((tool, index) => {
                const card = document.createElement('button');
                card.className = 'tool-card p-4 md:p-6 rounded-xl flex flex-col items-center text-center cursor-pointer focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--bg-light)] dark:focus:ring-offset-[var(--bg-dark)] focus:ring-[var(--primary-color)] fade-in-up';
                card.innerHTML = `
                    ${tool.icon}
                    <h2 class="font-semibold text-base md:text-lg text-gray-800 dark:text-gray-200">${tool.title}</h2>
                    <p class="text-xs md:text-sm text-gray-500 dark:text-gray-400 mt-1">${tool.desc}</p>
                `;
                card.style.animationDelay = `${index * 50}ms`;
                card.addEventListener('click', () => openModal(tool));
                toolsGrid.appendChild(card);
            });
        };

        init();
    });
    </script>
</body>
</html>